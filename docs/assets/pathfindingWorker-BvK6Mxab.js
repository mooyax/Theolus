(function(){"use strict";let z=0,y=0,h=null;self.onmessage=function(s){const{type:o,payload:e,id:i}=s.data;switch(o){case"INIT":P(e);break;case"UPDATE_CHUNK":v(e);break;case"UPDATE_CELL":_(e);break;case"FIND_PATH":const g=D(e.sx,e.sz,e.ex,e.ez,e.maxSteps);self.postMessage({type:"PATH_RESULT",id:i,payload:g});break;default:console.error("Unknown message type:",o)}};function P({w:s,h:o,data:e}){z=s,y=o,h=new Int16Array(e),console.log(`[Worker] Grid Initialized: ${z}x${y}`)}function _({x:s,z:o,h:e}){if(!h)return;const i=o*z+s;i>=0&&i<h.length&&(h[i]=e)}function v({startX:s,startZ:o,w:e,h:i,data:g}){}function D(s,o,e,i,g=0){if(!h)return null;const l=z,c=y;s=Math.round(s),o=Math.round(o),e=Math.round(e),i=Math.round(i),s=(s%l+l)%l,o=(o%c+c)%c,e=(e%l+l)%l,i=(i%c+c)%c;const d=(t,a)=>h[a*l+t];if(d(s,o)<=0){let t=!1;for(let a=-1;a<=1;a++){for(let f=-1;f<=1;f++){if(a===0&&f===0)continue;let u=(s+a+l)%l,r=(o+f+c)%c;if(d(u,r)>0){s=u,o=r,t=!0;break}}if(t)break}if(!t)return null}if(d(e,i)<=0){let t=!1;for(let a=1;a<=2;a++){for(let f=-a;f<=a;f++){for(let u=-a;u<=a;u++){if(f===0&&u===0)continue;let r=(e+f+l)%l,n=(i+u+c)%c;if(d(r,n)>0){e=r,i=n,t=!0;break}}if(t)break}if(t)break}if(!t)return null}const $={x:s,z:o,g:0,h:0,f:0,parent:null},M=[$],w=new Map;w.set(`${s},${o}`,$);const A=new Set;let C=0;const G=g>0?g:4e4;let E=$,U=1/0;for(;M.length>0;){if(C++,C>G){const r=[];let n=E;for(;n;)r.push({x:n.x,z:n.z}),n=n.parent;return r.reverse()}M.sort((r,n)=>r.f-n.f);const t=M.shift();t.h<U&&(U=t.h,E=t);const a=`${t.x},${t.z}`;if(w.delete(a),A.add(a),t.x===e&&t.z===i){const r=[];let n=t;for(;n;)r.push({x:n.x,z:n.z}),n=n.parent;return r.reverse()}const f=[{x:1,z:0,cost:1},{x:-1,z:0,cost:1},{x:0,z:1,cost:1},{x:0,z:-1,cost:1},{x:1,z:1,cost:1.414},{x:1,z:-1,cost:1.414},{x:-1,z:1,cost:1.414},{x:-1,z:-1,cost:1.414}],u=d(t.x,t.z);for(const r of f){let n=(t.x+r.x+l)%l,H=(t.z+r.z+c)%c;const S=`${n},${H}`;if(A.has(S))continue;const I=d(n,H);if(I<=0)continue;const m=Math.abs(I-u);if(m>2)continue;let N=.8*r.cost;I>8&&(N+=2),N+=m*1;const x=t.g+N;let p=w.get(S);if(p&&p.g<=x)continue;let b=Math.abs(n-e),k=Math.abs(H-i);b>l/2&&(b=l-b),k>c/2&&(k=c-k);const T=Math.sqrt(b*b+k*k)*.8;if(p)p.g=x,p.f=x+T,p.parent=t;else{const L={x:n,z:H,g:x,h:T,f:x+T,parent:t};M.push(L),w.set(S,L)}}}return null}})();
