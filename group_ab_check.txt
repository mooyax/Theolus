
 RUN  v4.0.15 C:/Users/mooya/develop/test

stdout | src/tests/CombatRequestHandoff.test.js > Request Responsiveness & Combat Handoff > Worker releases job when engaging in combat
[UnitCore.js] Unit Created ID:0 Role:worker Pos:10,10 Special:false
Run Logic...
[JobState] Entered. Target: undefined. Resume: UnitWanderState
Simulate Attacked...

stdout | src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should damage building population
Goblin 0 attacking house. Pop: 9.92

stdout | src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should destroy building when population drops below 1.0
Goblin 1 attacking house. Pop: 4.92

stdout | src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should destroy building even if fractional population remains (e.g. 0.5)
Goblin 2 attacking house. Pop: 5.42

stdout | src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should NOT destroy building if population remains >= 1.0
Goblin 3 attacking house. Pop: 6.92

stdout | src/tests/CombatBalance.test.js > Combat Balance Simulation > Knight vs Single Goblin (1v1) - AI Logic Check
[UnitCore.js] Unit Created ID:0 Role:knight Pos:0,0 Special:false
[Unit Debug V3] Start Logic. Night=false, Sleep=false, Action=undefined
[Unit Debug] ATTACKING Goblin 0
Goblin (normal) died. ID:0
[AI CHECK] KnightAction: Idle GoblinHP: -67

stdout | src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should take retaliation damage
Goblin 4 attacking house. Pop: 19.92

stdout | src/tests/CombatBalance.test.js > Combat Balance Simulation > Wizard vs Single Goblin (1v1) - Wizard should win
[UnitCore.js] Unit Created ID:1 Role:wizard Pos:0,0 Special:false
[Unit Debug] ATTACKING Goblin 1
Goblin (normal) died. ID:1

stdout | src/tests/CombatBalance.test.js > Combat Balance Simulation > Knight vs Swarm (1v5) - Knight should surviving
[UnitCore.js] Unit Created ID:2 Role:knight Pos:0,0 Special:false
[Unit Debug] ATTACKING Goblin g0
Goblin (normal) died. ID:g0
[Unit Debug] ATTACKING Goblin g1
Goblin (normal) died. ID:g1
[Unit Debug] ATTACKING Goblin g2
Goblin (normal) died. ID:g2
[Unit Debug] ATTACKING Goblin g3
Goblin (normal) died. ID:g3
[Unit Debug] ATTACKING Goblin g4
Goblin (normal) died. ID:g4

 笶ｯ src/tests/GoblinDestruction.test.js (5 tests | 5 failed) 57ms
     ﾃ・should damage building population 33ms
     ﾃ・should destroy building when population drops below 1.0 3ms
     ﾃ・should destroy building even if fractional population remains (e.g. 0.5) 5ms
     ﾃ・should NOT destroy building if population remains >= 1.0 4ms
     ﾃ・should take retaliation damage 8ms
stdout | src/tests/CombatBalance.test.js > Combat Balance Simulation > Load Game Persistence - Should resume movement
[UnitCore.js] Unit Created ID:3 Role:knight Pos:0,0 Special:false
[ActorDebug] Grid: 0,0 Target: 10,10 Diff: 10,10
[ActorDebug] Next: 0,1
[Unit 3] Moving onto Rock at 0,1 H:10 (Speed Penalty)
[ActorDebug] Check Move 0,1 -> true
[ActorDebug] Grid: 0,0 Target: 0,0 Diff: 0,0
[ActorDebug] Next: 0,0
[Unit 3] Moving onto Rock at 0,0 H:10 (Speed Penalty)
[ActorDebug] Check Move 0,0 -> true
Unit 3 migrating to 0,0 (Region undefined)
[ActorDebug] Grid: 0,0 Target: 0,0 Diff: 0,0
[ActorDebug] Next: 0,0
[Unit 3] Moving onto Rock at 0,0 H:10 (Speed Penalty)
[ActorDebug] Check Move 0,0 -> true
[UnitCore.js] Unit Created ID:4 Role:knight Pos:0,0 Special:false

 笶ｯ src/tests/CombatBalance.test.js (4 tests | 1 failed) 46ms
     笨・Knight vs Single Goblin (1v1) - AI Logic Check 13ms
     笨・Wizard vs Single Goblin (1v1) - Wizard should win 3ms
     笨・Knight vs Swarm (1v5) - Knight should surviving 5ms
     ﾃ・Load Game Persistence - Should resume movement 22ms
 笶ｯ src/tests/GhostHouse.test.js (1 test | 1 failed) 269ms
     ﾃ・should accumulate ghost buildings in entityGrid if not cleared during deserialize 265ms
stdout | src/tests/GoblinMobilization.test.js > Goblin Mobilization Verification > triggerWave should mobilize idle goblins
GoblinManager: Generation started...
GoblinManager: Generated 0 goblin caves after 5000 attempts.

stdout | src/tests/GoblinMobilization.test.js > Goblin Mobilization Verification > triggerWave should mobilize idle goblins
[GoblinManager] TRIGGERING WAVE Level 1 for Clan test_clan!
[Wave] Spawning 1 goblins at cave 10,10 (Lvl 1)
[GoblinManager] Mobilized 2 idle goblins from Clan test_clan to raid target!

stdout | src/tests/BuildingDestruction.test.js > Building Destruction Logic > should destroy building immediately when population hits 0
Goblin 0 attacking house. Pop: 0.00

stdout | src/tests/Hotspot.test.js > Global Battle Hotspots Logic > Clusters nearby battle reports
[Game] New Battle Hotspot at 10,10 (Region:1)

stdout | src/tests/Hotspot.test.js > Global Battle Hotspots Logic > Decays intensity
[Game] New Battle Hotspot at 10,10 (Region:1)

 笶ｯ src/tests/CombatRequestHandoff.test.js (2 tests | 2 failed) 624ms
     ﾃ・Worker releases job when engaging in combat 352ms
     ﾃ・forceAssignRequest prioritizes nearby busy unit over distant idle unit 270ms
stdout | src/tests/BuildingDestruction.test.js > Building Destruction Logic > should destroy building if already 0
Goblin 1 hitting Empty house. HP: -1950

stdout | src/tests/Hotspot.test.js > Global Battle Hotspots Logic > Mobilizes idle squads
[Game] Mobilizing Squad 1 to Hotspot at 50,50 (Intensity:100.0)

 笶ｯ src/tests/Hotspot.test.js (6 tests | 1 failed) 664ms
     笨・Clusters nearby battle reports  639ms
     笨・Decays intensity 2ms
     ﾃ・Mobilizes idle squads to intense hotspots (Updated Threshold) 12ms
     笨・Triggers autonomous patrol for idle Knights 3ms
     笨・Mobilizes idle squads 2ms
     笨・Does not mobilize across regions 1ms
 笶ｯ src/tests/ManaSystem.test.js (5 tests | 1 failed) 33ms
     笨・should block actions when mana is negative 4ms
     笨・should allow actions when mana is positive 1ms
     笨・should consume mana correctly 4ms
       ﾃ・should consume mana on raise terrain 18ms
       笨・should block raise terrain if mana is negative 3ms
stdout | src/tests/GoblinMobilization.test.js > Goblin Mobilization Verification > mobilizeClan should rely on getClanRaidTarget fallback
GoblinManager: Generation started...
GoblinManager: Generated 0 goblin caves after 5000 attempts.

stdout | src/tests/GoblinMobilization.test.js > Goblin Mobilization Verification > mobilizeClan should rely on getClanRaidTarget fallback
[GoblinManager] Mobilized 1 idle goblins from Clan test_clan_fallback to raid target!

stderr | src/tests/GoblinMobilization.test.js
[GoblinManager] Aborting spawn: Grid cell has no building. Self-healing/Destroying Cave.
[GoblinManager] Removing invalid cave at 10,10

 笨・src/tests/GoblinMobilization.test.js (2 tests) 332ms
stdout | src/tests/BuildingDestruction.test.js > Building Destruction Logic > should NOT destroy building if population remains > 0
Goblin 2 attacking house. Pop: 30.00

 笶ｯ src/tests/BuildingDestruction.test.js (3 tests | 1 failed) 412ms
     ﾃ・should destroy building immediately when population hits 0 228ms
     笨・should destroy building if already 0 81ms
     笨・should NOT destroy building if population remains > 0 100ms
stdout | src/tests/GoblinFixes.test.js > Goblin Fixes Verification > GoblinManager difficulty scaling increases stronger goblin probability
GoblinManager: Generation started...
GoblinManager: Generated 0 goblin caves after 5000 attempts.

 笶ｯ src/tests/GoblinFixes.test.js (4 tests | 1 failed) 478ms
     笨・Entity.getDistance should handle wrapping 155ms
     笨・Terrain.findBestTarget should find wrapped targets 102ms
     笨・Terrain.findBestTarget should handle non-wrapping case correctly (sanity) 108ms
     ﾃ・GoblinManager difficulty scaling increases stronger goblin probability 108ms
stdout | src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should tag new requests with createdAt timestamp
Game constructor called

stdout | src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should cleanup expired pending requests
Game constructor called

stdout | src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should NOT cleanup assigned requests even if old
Game constructor called

stdout | src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should cancel request via Proximity Search
Game constructor called

stdout | src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should prioritize nearest request when cancelling
Game constructor called

 笶ｯ src/tests/RequestLifecycle.test.js (5 tests | 5 failed) 891ms
     ﾃ・should tag new requests with createdAt timestamp 282ms
     ﾃ・should cleanup expired pending requests 168ms
     ﾃ・should NOT cleanup assigned requests even if old 153ms
     ﾃ・should cancel request via Proximity Search 151ms
     ﾃ・should prioritize nearest request when cancelling 135ms

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ Failed Tests 18 竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ

 FAIL  src/tests/BuildingDestruction.test.js > Building Destruction Logic > should destroy building immediately when population hits 0
AssertionError: expected "vi.fn()" to be called at least once
 笶ｯ src/tests/BuildingDestruction.test.js:119:40
    117| 
    118|         expect(house.userData.population).toBeLessThanOrEqual(0);
    119|         expect(goblin.destroyBuilding).toHaveBeenCalled();
       |                                        ^
    120|         expect(goblin.destroyBuilding).toHaveBeenCalledWith(house);
    121|     });

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[1/18]竡ｯ

 FAIL  src/tests/CombatBalance.test.js > Combat Balance Simulation > Load Game Persistence - Should resume movement
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 笶ｯ src/tests/CombatBalance.test.js:269:29
    267|         // Verify Restoration
    268|         // Verify Restoration
    269|         expect(u2.isMoving).toBe(true);
       |                             ^
    270|         // Note: triggerMove calculates NEXT TILE, not final destinati窶ｦ
    271|         // From 0,0 to 10,10. dx=10, dz=10. 10 > 10 is false. Z increm窶ｦ

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[2/18]竡ｯ

 FAIL  src/tests/CombatRequestHandoff.test.js > Request Responsiveness & Combat Handoff > Worker releases job when engaging in combat
AssertionError: expected "vi.fn()" to be called at least once
 笶ｯ src/tests/CombatRequestHandoff.test.js:119:37
    117|         unit.takeDamage(1, enemy); // Enemy attacks unit
    118| 
    119|         expect(game.releaseRequest).toHaveBeenCalled();
       |                                     ^
    120|         expect(unit.targetRequest).toBeNull();
    121|     });

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[3/18]竡ｯ

 FAIL  src/tests/CombatRequestHandoff.test.js > Request Responsiveness & Combat Handoff > forceAssignRequest prioritizes nearby busy unit over distant idle unit
AssertionError: expected "vi.fn()" to be called at least once
 笶ｯ src/tests/CombatRequestHandoff.test.js:147:39
    145|         vi.runAllTimers();
    146| 
    147|         expect(mockGame.claimRequest).toHaveBeenCalled();
       |                                       ^
    148|         // Check if Unit 1 was the one claimed (mockGame.claimRequest 窶ｦ
    149|         const calls = mockGame.claimRequest.mock.calls;

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[4/18]竡ｯ

 FAIL  src/tests/GhostHouse.test.js > Terrain Ghost House Test > should accumulate ghost buildings in entityGrid if not cleared during deserialize
Error: [vitest] No "LineSegments" export is defined on the "three" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

vi.mock(import("three"), async (importOriginal) => {
  const actual = await importOriginal()
  return {
    ...actual,
    // your mocked methods
  }
})

 笶ｯ Terrain.createMesh src/Terrain.js:540:36
    538|         });
    539| 
    540|         const gridMesh = new THREE.LineSegments(gridGeo, gridMat);
       |                                    ^
    541|         gridMesh.position.set(0, 0, 0.04); // Slightly below dots
    542|         this.mesh.add(gridMesh);
 笶ｯ Terrain.initTerrain src/Terrain.js:287:14
 笶ｯ new Terrain src/Terrain.js:26:14
 笶ｯ src/tests/GhostHouse.test.js:68:19

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[5/18]竡ｯ

 FAIL  src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should damage building population
AssertionError: expected 9.92 to be 5 // Object.is equality

- Expected
+ Received

- 5
+ 9.92

 笶ｯ src/tests/GoblinDestruction.test.js:62:46
     60|         goblin.attackBuilding(building);
     61|         // Damage is 5 for House
     62|         expect(building.userData.population).toBe(5);
       |                                              ^
     63|     });
     64| 

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[6/18]竡ｯ

 FAIL  src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should destroy building when population drops below 1.0
AssertionError: expected 4.92 to be +0 // Object.is equality

- Expected
+ Received

- 0
+ 4.92

 笶ｯ src/tests/GoblinDestruction.test.js:70:46
     68| 
     69|         // 5 - 5 = 0. Should destroy.
     70|         expect(building.userData.population).toBe(0);
       |                                              ^
     71|         expect(mockTerrain.removeBuilding).toHaveBeenCalledWith(buildi窶ｦ
     72|     });

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[7/18]竡ｯ

 FAIL  src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should destroy building even if fractional population remains (e.g. 0.5)
AssertionError: expected 5.42 to be 0.5 // Object.is equality

- Expected
+ Received

- 0.5
+ 5.42

 笶ｯ src/tests/GoblinDestruction.test.js:79:46
     77|         goblin.attackBuilding(building); // Damage 5 -> 0.5
     78| 
     79|         expect(building.userData.population).toBe(0.5);
       |                                              ^
     80|         // Is 0.5 < 1.0? Yes.
     81|         expect(mockTerrain.removeBuilding).toHaveBeenCalledWith(buildi窶ｦ

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[8/18]竡ｯ

 FAIL  src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should NOT destroy building if population remains >= 1.0
AssertionError: expected 6.92 to be 2 // Object.is equality

- Expected
+ Received

- 2
+ 6.92

 笶ｯ src/tests/GoblinDestruction.test.js:88:46
     86|         goblin.attackBuilding(building); // Damage 5 -> 2
     87| 
     88|         expect(building.userData.population).toBe(2);
       |                                              ^
     89|         expect(mockTerrain.removeBuilding).not.toHaveBeenCalled();
     90|     });

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[9/18]竡ｯ

 FAIL  src/tests/GoblinDestruction.test.js > Goblin Building Destruction > should take retaliation damage
AssertionError: expected 81 to be 97 // Object.is equality

- Expected
+ Received

- 97
+ 81

 笶ｯ src/tests/GoblinDestruction.test.js:98:27
     96|         goblin.attackBuilding(building); // Drops to 15. Retaliation =窶ｦ
     97| 
     98|         expect(goblin.hp).toBe(initialHP - 3);
       |                           ^
     99|     });
    100| });

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[10/18]竡ｯ

 FAIL  src/tests/GoblinFixes.test.js > Goblin Fixes Verification > GoblinManager difficulty scaling increases stronger goblin probability
TypeError: this.scene.getObjectByName is not a function
 笶ｯ new Goblin src/Goblin.js:73:39
     71| 
     72|         // Ensure mesh group exists
     73|         if (this.scene && !this.scene.getObjectByName('GoblinGroup')) {
       |                                       ^
     74|             // managed by GoblinRenderer usually
     75|         }
 笶ｯ GoblinManager.spawnGoblin src/GoblinManager.js:542:24
 笶ｯ src/tests/GoblinFixes.test.js:135:16

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[11/18]竡ｯ

 FAIL  src/tests/Hotspot.test.js > Global Battle Hotspots Logic > Mobilizes idle squads to intense hotspots (Updated Threshold)
AssertionError: expected "vi.fn()" to be called with arguments: [ 1, 100, 20 ]

Number of calls: 0

 笶ｯ src/tests/Hotspot.test.js:67:31
     65|         mobFn(0.1);
     66| 
     67|         expect(reportSquadFn).toHaveBeenCalledWith(1, 100, 20);
       |                               ^
     68|     });
     69| 

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[12/18]竡ｯ

 FAIL  src/tests/ManaSystem.test.js > Mana System > InputManager Integration > should consume mana on raise terrain
AssertionError: expected "vi.fn()" to be called at least once
 笶ｯ src/tests/ManaSystem.test.js:83:39
     81|             inputManager.handleInteraction(event);
     82| 
     83|             expect(mockTerrain.raise).toHaveBeenCalled();
       |                                       ^
     84|             expect(mockGame.consumeMana).toHaveBeenCalledWith(10);
     85|             expect(mockGame.mana).toBe(90);

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[13/18]竡ｯ

 FAIL  src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should tag new requests with createdAt timestamp
 FAIL  src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should cleanup expired pending requests
 FAIL  src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should NOT cleanup assigned requests even if old
 FAIL  src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should cancel request via Proximity Search
 FAIL  src/tests/RequestLifecycle.test.js > Game Request Lifecycle > should prioritize nearest request when cancelling
TypeError: attribute.getX is not a function
 笶ｯ Vector3.fromBufferAttribute node_modules/three/build/three.core.js:5686:22
 笶ｯ BufferGeometry.computeVertexNormals node_modules/three/build/three.core.js:19857:9
 笶ｯ Function.initAssets src/BirdManager.js:26:17
     24|         ]);
     25|         wingGeo.setAttribute('position', new THREE.BufferAttribute(win窶ｦ
     26|         wingGeo.computeVertexNormals();
       |                 ^
     27|         BirdManager.assets.geometries.wing = wingGeo;
     28| 
 笶ｯ new BirdManager src/BirdManager.js:37:21
 笶ｯ new Game src/Game.js:150:28
 笶ｯ src/tests/RequestLifecycle.test.js:157:16

竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ竡ｯ[14/18]竡ｯ


 Test Files  9 failed | 1 passed (10)
      Tests  18 failed | 19 passed (37)
   Start at  21:36:41
   Duration  3.40s (transform 3.11s, setup 555ms, import 4.28s, tests 3.81s, environment 12.31s)

