# ゲームデザイン仕様書 / ルール定義

このドキュメントは、ゲームロジックと挙動に関する「信頼できる唯一の情報源（Source of Truth）」として機能します。将来的な変更は、一貫性を保ち、合意された機能の退行を防ぐために、必ずこのドキュメントを参照・更新してから行ってください。

## 1. ジョブシステム (Worker AI)

### 1.1. ジョブの種類
- **統一されたリクエストシステム**: すべてのジョブ（隆起、沈降、建設など）は等しく扱われます。「手動（Manual）」と「自動（Auto）」による優先度や永続性の区別はありません。
- **優先度**: プレイヤーが指示したすべてのリクエストは、高優先度（High Priority）として扱われます。

### 1.2. 永続性と放棄（Persistence & Abandonment）
- **基本ルール**: 労働者（Worker）が実行不可能な場合、ジョブは**無期限に保持されません**。
- **放棄の条件**:
    1.  **到達不能 (Unreachable)**: 経路探索が `null` または明確な失敗を返した場合。
    2.  **スタック (Stuck)**: ユニットが物理的に45秒以上移動できない、または微小な移動失敗が100回累積した場合。
        *   **注意**: 建物は障害物ではありません（通過可能）。
        *   **Region Mapとの関係**: 経路探索にはRegion Mapが使用されますが、地形変更からRegion再計算およびPathfinding Workerへのデータ同期には**タイムラグ（非同期処理）**が発生します。この間に「計算上は移動可能だが実際は崖」という状況が発生しうるため、物理的なスタック判定は**最終的な安全装置（Safety Net）**として必須となります。
- **放棄時の挙動**:
    - ジョブはグローバルキューに**解放（Release）**され、ステータスは `pending`（未割り当て）に戻ります。
    - **ジョブ自体**に `excludedUntil`（除外タイマー）が設定され、**15秒間、誰にも割り当てられない状態**になります（Global Cooldown）。
    - これにより、あるユニットが到達不能と判断したジョブに、別のユニットが即座にアサインされて失敗する連鎖を防ぎます。
- **リトライ（再試行）ロジック**:
    - 15秒経過後、ジョブの除外タイマーが解除され、再び全ユニットが取得可能になります。
    - **地形変化（Terrain Changes）**が発生し、ターゲットへの経路が開通した場合でも、ジョブ自体はキューに残っているため、（無視タイマー完了後の）元のユニットや、他の空いているユニットによって再度実行されます。

## 2. 戦闘システム (Combat System)

### 2.1. 労働者の挙動 (パッシブ)
- **自衛 (Self-Defense)**: 労働者は仕事に専念しますが、攻撃を受けた場合は反撃（Retaliate）します。
- **脅威チェック (Threat Check)**:
    - アイドル/徘徊（Idle/Wander）に戻る前に、近くのゴブリン（脅威）をチェックします。
    - ゴブリンが見つからない場合、視界内の**敵対的建造物**（ゴブリンの小屋/洞窟）をチェックします。
    - 建造物が見つかった場合、将来の脅威を排除するために攻撃を行うことがあります。

### 2.2. 兵士の挙動 (アグレッシブ)
- **騎士/魔法使い**: 積極的に敵を索敵し、迎撃に向かいます。
- **襲撃ロジック (Raid Logic)**: アイドル状態の時、破壊すべきゴブリンの洞窟を能動的に探して移動します。

### 2.3. 戦闘の安定性 (Combat Stability)
- **ターゲット判定 (Targeting)**:
    - **探索範囲**: 半径8マス以内の敵をスキャンします。
    - **到達性チェック (Reachability)**: 敵が見つかった場合、直線距離だけでなく「到達可能か（同じRegionか、または経路があるか）」を確認します。
        - 到達不能（対岸など）と判断された場合、その敵は無視します。
        - これにより、物理的に移動できない敵に対して永遠に反応し続ける（スタックする）現象を防ぎます。
- **ステートロック (State Persistence)**:
    - **戦闘状態 (CombatState)**: ターゲットが死亡するか、完全に消失するまで、他の状態（Wander等）には遷移しません。
    - **作業状態 (JobState)**: 割り当てられたタスクが完了するか、キャンセルされるまで、他の状態には遷移しません（自衛のための反撃は例外ですが、作業放棄はしません）。

### 2.4. 建物の破壊 (Building Destruction)
- **消滅条件 (Destruction Condition)**: 建物のHPが0になり、かつ**内部の人口（Population）が0**になった時のみ、建物は完全に破壊され、マップから除去されます。
- **略奪（Looting）**: HPが0になっても人が残っている場合、建物は「機能不全」状態として残り、ゴブリンは人口を減らすための攻撃を継続します。
- **自衛反撃 (Retaliation)**: 人口が残っている建物は、攻撃者に対して反撃（カウンターダメージ）を行います。

## 3. 夜間行動 (Night Behavior)

### 3.1. 労働者 (Worker)
- **挙動**: 夜間、仕事（JobState）または戦闘（CombatState）中でない場合、最寄りのシェルター（家や城）を探して帰宅し、就寝（SleepState）します。
- **目的**: 労働者の安全確保と、夜間の経済活動の停止を表現するため。

### 3.2. 軍事ユニット (Knight, Wizard 等)
- **挙動**: 夜間であっても帰宅・就寝はしません。
- **継続任務**: パトロール、索敵、戦闘など、与えられた任務を夜通し継続します。
- **目的**: 防衛線や攻撃部隊が夜間に無防備になるのを防ぎ、戦略的な緊張感を維持するため。

## 4. スポーンシステム (Spawning System)

### 4.1. ゴブリン
- **発生源**: ゴブリンの洞窟（Caves）。
- **制限**: `GoblinManager` による最大人口キャップで制御されます。
- **増加**: 一定間隔で発生し、`Building.js` 内の「人口増加（Population Growth）」ロジックによって頻度が調整されます。

### 4.2. ユニット (プレイヤー側)
- **発生源**: 家（Workers）、城（Soldiers）。
- **トリガー**: プレイヤーによる「勧誘（Recruit）」クリック、または自動人口増加（有効な場合）。

## 5. 技術的制約 (Technical Constraints)
- **経路探索 (Pathfinding)**: 非同期Web Workerを使用します。ユニットは `isPathfinding` 状態を適切に処理し、メインスレッドをフリーズさせないようにする必要があります。
    *   **線形移動 (Linear Fallback)**: ターゲットまでの距離が **4.0グリッド以下** の場合、パフォーマンス優先で重い経路探索（A*）をスキップし、直線的（または8方向）な移動を試みます。
- **振動防止 (Oscillation Prevention)**: 到達不能なターゲットを一定時間「無視（Ignore）」することは、ステートの高速切り替え（フリッカー）を防ぐための標準的なメカニズムです。

## 6. 移動システム (Movement System)

### 6.1. 地形による移動速度 (Terrain Speed)
- **基本ルール**: ユニットは地形の特性に応じて移動速度（`moveDuration`: 1マス移動にかかる秒数）を変化させます。
- **速度設定**:
    | 地形タイプ | 条件 | moveDuration (秒) | 速度倍率 (vs 基本) |
    | :--- | :--- | :--- | :--- |
    | **平地 (Normal)** | 高度 <= 4.0 | **0.8** | 1.0x (基準) |
    | **森林 (Forest)** | 高度 <= 9.0 | **0.8** | 1.0x |
    | **湿地 (Swamp)** | 湿度 (Moisture) > 0.8 | **2.0** | 0.4x (遅い) |
    | **坂道 (Slope)** | 高さ差 > 0.1 | **3.0** | ~0.27x (かなり遅い) |
    | **岩場 (Rock)** | 高さ (Height) > 9.0 | **6.0** | ~0.13x (非常に遅い) |

### 6.2. 経路探索コスト (Pathfinding Cost)
- **コスト整合性**: A*経路探索のコスト計算（Heuristic & G-Score）は、上記の物理移動速度と整合性が取れている必要があります。
- **回避挙動**: ユニットは、可能な限り「湿地」「岩場」を避けて、平地や街道（もしあれば）を通るルートを選択します。

## AI 状態とアクションの仕様

人間（Unit）とゴブリン（Goblin）の AI は、内部的なクラス名（State）とユーザーに表示される文字列（Action）が以下のように統一されています。

### 共通 / 人間ユニット
| State (クラス名) | Action (表示) | 説明 |
| :--- | :--- | :--- |
| `Wander` | **`Idle`** | 停止中（次の目的地を待機中） |
| `Wander` | **`Moving`** | 地形を徘徊中 |
| `Job` | `Approaching Job` | プレイヤーの指示した場所へ移動中 |
| `Job` | `Working` | 指示された作業を実行中 |
| `Combat` | `Fighting` | 敵対勢力と交戦中 |
| `Combat` | `Patrolling` | 防衛ポイントを警戒移動中 |
| `Sleep` | `Sleeping` | 夜間にシェルターで休息中 |
| `Build` | `Building` | 自律的に建物を建設中 |

### ゴブリン
| State (クラス名) | Action (表示) | 説明 |
| :--- | :--- | :--- |
| `Wander` | **`Idle`** | 停止中 |
| `Wander` | **`Moving`** | 徘徊中 |
| `Raid` | `Raiding` | プレイヤー拠点へ進軍中 |
| `Combat` | `Fighting` | 交戦中 |
| `Retreat` | `Retreating` | 洞窟へ撤退中 |
| `Build` | `Building` | ゴブリン小屋を建設中 |

---
### 6.3. バイオーム高度定義 (Biome Height Levels)
地形生成時に使用されるバイオームの境界値は以下の通り固定されています。

| バイオーム | 高度範囲 | 説明 |
| :--- | :--- | :--- |
| **水面 (Water)** | <= 0 | ミニマップ上でのみ青色で表示されます。 |
| **砂浜 (Beach)** | 高度 1 (海に隣接) | 陸地と水面の境界に生成されます。 |
| **草原 (Plains)** | 0.0 〜 4.0 | 基本的な活動領域です。 |

※地形全体の「険しさ（標高）」は、`GameConfig.generation.rockHeight` パラメータによって制御され、これにより各バイオームの面積比率が変化します。
※砂浜は、高度 1 のタイルのうち、上下左右のいずれかに水面（高度 0 以下）がある場合にのみ表示されます。

最終更新日: 2026-02-18
